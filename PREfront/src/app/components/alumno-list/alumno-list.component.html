<div class="dashboard-container">
    <div class="main-card shadow-lg">

        <div class="card-header-actions">
            <div class="title-section">
                <h2 class="page-title">Directorio de Alumnos</h2>
                <p class="text-muted">Gestión escolar y matrículas</p>
            </div>

            <div class="buttons-section d-flex gap-2">
                <button class="btn btn-outline-primary fw-bold" (click)="descargarTodosLosCarnets()"
                    [disabled]="generandoMasivo || alumnos.length === 0">

                    <span *ngIf="!generandoMasivo">
                        <i class="bi bi-file-earmark-pdf-fill me-2"></i> Descargar Carnets
                    </span>

                    <span *ngIf="generandoMasivo">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        {{ progresoMasivo }}
                    </span>
                </button>

                <a routerLink="/alumnos/nuevo" class="btn-academic btn-create">
                    <i class="bi bi-person-plus-fill"></i> Nuevo Alumno
                </a>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table custom-table align-middle">
                <thead>
                    <tr>
                        <th scope="col" class="ps-4">Estudiante</th>
                        <th scope="col">Documento</th>
                        <th scope="col">Contacto</th>
                        <th scope="col">Apoderado</th>
                        <th scope="col" class="text-end pe-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let alumno of alumnos" class="table-row-hover">
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="student-avatar me-3">
                                    {{ alumno.nombres.charAt(0) }}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">{{ alumno.apellidos }}</div>
                                    <div class="text-muted small">{{ alumno.nombres }}</div>
                                    <span class="badge bg-light text-secondary border mt-1">
                                        {{ alumno.genero === 'M' ? 'Masculino' : 'Femenino' }}
                                    </span>
                                </div>
                            </div>
                        </td>

                        <td>
                            <span class="badge-dni">
                                <i class="bi bi-card-heading"></i> {{ alumno.dni_ce }}
                            </span>
                        </td>

                        <td>
                            <div *ngIf="alumno.celular; else noCel">
                                <i class="bi bi-whatsapp text-success"></i> {{ alumno.celular }}
                            </div>
                            <ng-template #noCel>
                                <span class="text-muted small">--</span>
                            </ng-template>
                        </td>

                        <td>
                            <div class="small">
                                <i class="bi bi-person text-primary"></i> {{ alumno.apoderado }}
                            </div>
                            <div class="small text-muted" *ngIf="alumno.cel_apoderado">
                                <i class="bi bi-phone"></i> {{ alumno.cel_apoderado }}
                            </div>
                        </td>

                        <td class="text-end pe-4">
                            <div class="d-flex justify-content-end gap-2">

                                <button type="button" (click)="verCarnet(alumno)" class="btn-icon btn-carnet"
                                    title="Ver Carnet QR">
                                    <i class="bi bi-qr-code"></i>
                                </button>

                                <a [routerLink]="['/alumnos/editar', alumno.id]" class="btn-icon btn-edit"
                                    title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </a>

                                <button type="button" (click)="eliminarAlumno(alumno.id!)" class="btn-icon btn-delete"
                                    title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div *ngIf="alumnos.length === 0" class="text-center py-5">
                <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay alumnos registrados aún.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop fade show" *ngIf="alumnoSeleccionadoCarnet"></div>

<div class="modal fade show" *ngIf="alumnoSeleccionadoCarnet" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-transparent border-0 shadow-none">

            <div class="text-end mb-2">
                <button type="button" class="btn-close btn-close-white bg-white" aria-label="Close"
                    (click)="cerrarCarnet()"></button>
            </div>

            <app-carnet-digital [alumno]="alumnoSeleccionadoCarnet"></app-carnet-digital>

        </div>
    </div>
</div>

<div id="contenedor-carnets-masivos" style="position: absolute; left: -9999px; top: 0; width: 350px;">

    <div *ngFor="let alumno of alumnos" style="margin-bottom: 20px;">

        <app-carnet-digital [alumno]="alumno" [ocultarAcciones]="true"></app-carnet-digital>

    </div>