<div class="dashboard-container fade-in">
    <div class="container-fluid">

        <div class="main-card">

            <div class="card-header-actions">
                <h3 class="page-title">
                    <i class="bi bi-calendar2-check"></i>
                    Reporte de Asistencia
                </h3>
                <div *ngIf="cargando" class="spinner-border text-primary spinner-border-sm" role="status"></div>
            </div>

            <div class="filters-section">
                <div class="row g-3">

                    <div class="col-md-3">
                        <label class="form-label">Nivel Académico</label>
                        <select class="form-select" [(ngModel)]="nivelSeleccionado" (change)="onNivelChange()">
                            <option [ngValue]="null">-- Seleccione --</option>
                            <option *ngFor="let nivel of niveles" [value]="nivel.id">
                                {{ nivel.nombre }}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Sección</label>
                        <select class="form-select" [(ngModel)]="seccionSeleccionada" [disabled]="!nivelSeleccionado">
                            <option [ngValue]="null">-- Seleccione --</option>
                            <option *ngFor="let sec of seccionesFiltradas" [value]="sec.id">
                                {{ sec.nombre }} - {{ sec.nombre_nivel }}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Fecha de Reporte</label>
                        <input type="date" class="form-control" [(ngModel)]="fechaSeleccionada">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn-search" (click)="buscarAsistencias()"
                            [disabled]="cargando || !nivelSeleccionado || !seccionSeleccionada">
                            <i class="bi bi-search"></i> Consultar
                        </button>
                    </div>

                </div>
            </div>

            <div class="table-container" *ngIf="asistencias.length > 0; else emptyState">

                <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-white border-bottom">
                    <span class="text-muted small fw-bold">
                        RESULTADOS: {{ asistencias.length }} ALUMNOS
                    </span>
                    <button class="btn btn-sm btn-outline-danger d-flex align-items-center gap-2"
                        (click)="exportarPDF()">
                        <i class="bi bi-file-pdf"></i> Exportar PDF
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table custom-table mb-0">
                        <thead>
                            <tr>
                                <th width="5%" class="text-center">#</th>
                                <th width="40%">Alumno</th>
                                <th width="20%" class="text-center">Hora Ingreso</th>
                                <th width="20%" class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of asistencias; let i = index" class="table-row-hover">
                                <td class="text-center text-muted fw-bold">{{ i + 1 }}</td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="student-name">{{ item.apellidos }}, {{ item.nombres }}</span>
                                        <small><span class="dni-text">{{ item.dni_ce }}</span></small>
                                    </div>
                                </td>
                                <td class="text-center font-monospace">{{ item.hora_entrada }}</td>
                                <td class="text-center">
                                    <span class="status-badge" [ngClass]="{
                                            'status-puntual': item.situacion === 'PUNTUAL',
                                            'status-tarde': item.situacion === 'TARDE',
                                            'status-falta': item.situacion === 'FALTA'
                                        }">
                                        {{ item.situacion }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <ng-template #emptyState>
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-clipboard-data"></i>
                    </div>

                    <div *ngIf="busquedaRealizada && !cargando">
                        <h5 class="empty-text">No se encontraron registros.</h5>
                        <p class="text-muted small">Intenta con otra fecha o verifica la asistencia.</p>
                    </div>

                    <div *ngIf="!busquedaRealizada && !cargando">
                        <h5 class="empty-text">Seleccione los filtros para ver el reporte.</h5>
                        <p class="text-muted small">Elija Nivel, Sección y Fecha, luego presione "Consultar".</p>
                    </div>
                </div>
            </ng-template>

        </div>
    </div>
</div>